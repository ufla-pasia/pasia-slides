---
title: Desenvolvendo Jogos e POO
subtitle: PASIA - Aula T.9
---

##  

O conte√∫do dessa aula √© baseado nos **cap√≠tulos 9, 12 e 13** do livro:


![](imagens/livro_curso_intensivo_python.jpg){fig-align="center" fig-alt="Capa do livro de Curso Intensivo de Python." style="max-height: 50vh; width: auto;"}

##

Nessa aula n√≥s vamos [desenvolver um jogo]{.alert} usando a biblioteca [`pygame`]{.alert}.

- E, para isso,  usaremos conceitos de POO: [Programa√ß√£o Orientada a Objetos]{.alert}.

. . .

Usaremos POO porque um jogo √© um projeto bem mais complexo do que os
exemplos que vimos na disciplina at√© agora.

- Mas, em vez de apresentar como se implementa OO em Python e depois desenvolver o jogo,
- vamos aprender a usar OO √† medida que o jogo √© desenvolvido.

# Ideias sobre o formato da aula {background-color="#40666e"}

##

Ao preparar a aula, estudei os cap√≠tulos do livro.

- E tamb√©m experimentei usar um Assistente de IA em modo interativo.

. . .

Testei primeiro o Copilot e depois o ChatGPT.

- Apresento a seguir um resumo dessas tentativas.

## Experimentando o Copilot

_(com GPT 4.1 no modo Ask)_

::: {.callout-caution title="Prompt" icon="false"}
Gostaria de iniciar uma sess√£o interativa para aprender a usar a biblioteca pygame para desenvolver um jogo 2D em Python. Nesta se√ß√£o considere que conhe√ßo o b√°sico de Python, mas nunca utilizei Orienta√ß√£o a Objetos nessa linguagem (eu aprendi usando Java). Gostaria que o jogo fosse constru√≠do um passo de cada vez, de forma bem did√°tica. O jogo se chamar√° Invas√£o Alien√≠gena. O jogador controlar√° uma nave que ficar√° na parte inferior da tela e poder√° se movimentar da direita para a esquerda. A nave consegue atirar. Os inimigos s√£o naves alien√≠genas que aparecem no topo da tela e se movimentam lateralmente, hora para esquerda, hora para a direita e tamb√©m se movimentam verticalmente, descendo em dire√ß√£o √† nave do jogador. Se as nave alien√≠genas atingirem a nave do jogador, o jogo termina. Se o tiro da nave do jogador atinge uma nave alien√≠gena, ela √© eliminada.
:::

##


O copilot rodou com `@workspace`, gerando uma estrutura de projeto com o jogo j√° "pronto" e sem nenhuma intera√ß√£o.

- Mas o projeto tinha v√°rios erros.

. . .

Cliquei em `Rerun without`

- A√≠ sim, o jogo come√ßou a ser gerado em um processo interativo.
- E eu podia direcionar a sequ√™ncia da conversa pedindo mais ou menos detalhes.
- Mas o resultado n√£o era t√£o bom quanto os cap√≠tulos de livro, pois muita coisa 
  era feita de forma direta, sem uma explica√ß√£o clara.

## Experimentando o ChatGPT

Experimentei o mesmo prompt no ChatGPT (veja [aqui](https://chatgpt.com/share/68e1078b-4544-800e-a468-29bfe8b4b34b)).

- O resultado foi mais interessante que usando o Copilot.
- As partes do c√≥digo que eram criadas eram explicadas em mais detalhes.
- Apesar de ter alguns erros em exemplos (de Java) de vez em quando.
- Foram tamb√©m legais as sugest√µes de onde conseguir imagens.

##

Mas, no geral, o material do livro era realmente bem mais did√°tico.

- E usava constru√ß√µes e funcionalidades importantes do pygame que 
  eram ignoradas nas sess√µes com Assitentes de AI.

. . .

Eu poderia tentar uma **Engenharia de Prompt** para melhorar o resultado.

- Mas acabei decidindo basear a aula nos cap√≠tulos do livro mesmo.
- E, na Aula Pr√°tica, a ideia √© que voc√™s incrementem o jogo com ajuda do Copilot.

# Invas√£o Alien√≠gena {background-color="#40666e"}

## Planejando seu projeto

. . .

Antes de come√ßar um projeto maior como um jogo,

- √© essencial definir bem o que se quer desenvolver.

. . .

No caso de um jogo, isso significa saber exatamente que jogo se quer desenvolver
e como ele vai funcionar.

- Para o nosso exemplo, o jogo ser√° uma vers√£o simplificada do cl√°ssico
  _Space Invaders_.
- A descri√ß√£o dada no prompt usado com os Assistentes de AI √© um come√ßo.

##

Mas a descri√ß√£o completa do jogo, dada no livro √©:

::: {.callout-note title="Planejamento do Jogo" icon="false" .nonincremental .smaller}
No jogo _Invas√£o Alien√≠gena_, o jogador controla uma nave que aparece no centro inferior da tela.
O jogador pode controlar a nave para a direita e para a esquerda, usando as setas do teclado e
atirar usando a barra de espa√ßo. Quando o jogo come√ßa, um esquadr√£o de alien√≠genas toma conta do
c√©u, deloscando-se para a esquerda e para a direita, enquanto desce pela tela. O jogador pode
destruir os alien√≠genas ao disparar. Se o jogador destruir todos os alien√≠genas, aparece um
novo esquadr√£o que se desloca mais r√°pido que o esquadr√£o anterior. Se algum alien√≠gena 
encostar na nave do jogador ou chegar √† parte inferior da tela, o jogador perde uma nave.
O jogo termina quando o jogador perde tr√™s naves.
:::

## Instalando PyGame

Pygame n√£o √© um m√≥dulo _built-in_, portanto, precisa ser instalado.

- Logo, vamos usar a estrat√©gia de criar um arqiuvo `requirements.txt`.
- E instalar o pygame em um ambiente virtual.

## Iniciando o Projeto do Jogo

::: {.r-fit-code .nonincremental}
```{.python filename="invasao_alien.py"}
import sys

import pygame

class InvasaoAlien:
    """Classe geral para gerenciar ativos e comportamento do jogo."""

    def __init__(self):
        """Inicializa o jogo e cria os recursos do jogo."""
        pygame.init()                                      # 1

        self.tela = pygame.display.set_mode((1200, 800))   # 2
        pygame.display.set_caption("Invas√£o Alien√≠gena")
        
    def executar_jogo(self):
        """Inicia o loop principal do jogo."""
        while True:                                        # 3
            # Observa eventos de teclado e mouse.
            for evento in pygame.event.get():              # 4
                if evento.type == pygame.QUIT:             # 5
                    sys.exit()

            pygame.display.flip()                          # 6

if __name__ == '__main__':
    ai = InvasaoAlien()                                   
    ai.executar_jogo()                                    
```
:::

##

Destaques no c√≥digo:

1. Inicializa as configura√ß√µes que o `pygame` precisa para funcionar corretamente.
2. Cria uma janela para exibi√ß√£o (_Surface_).
3. Loop de jogo.
4. Loop dos eventos detectados desde a √∫ltima itera√ß√£o.
5. Evento gerado quando o jogador clica no bot√£o de fechar a janela.
6. Atualiza o desenho na tela (_double buffer_).

## Classes em Python

- Classes s√£o declaradas com a palavra-chave `class`.
  - A conven√ß√£o √© usar nomes `camelCase` para classes.
  - E `snake_case` para atributos e m√©todos.
- O m√©todo `__init__()` √© o construtor da classe.
- Todos os m√©todos da classe precisam, obrigatoriamente,
  declarar um par√¢metro chamado `self`.
  - `self` √© o equivalente ao `this` do Java.
- Os atributos da classe s√£o criados dinamicamente.
  - Eles n√£o s√£o previamente declarados como em Java.
  - Assim, um atributo pode ser criado em qualquer m√©todo, mas, recomenda-se 
    cri√°-los no construtor da classe.

## Classes em Python

- Atributos e m√©todos da classe s√£o sempre acessados usando `self.`.
- Objetos s√£o criados com a sintaxe `variavel = Classe()`.
- M√©todos s√£o chamados com `variavel.metodo(param1, param2, ...`).
  - Observa√ß√£o importante, n√£o passamos valor para o par√¢metro `self` explicitamente.
  - Internamente, Python transforma a chamada acima em `metodo(variavel, param1, param2, ...)`.
  - Portanto, `self` vai receber o endere√ßo da `variavel`. 

## Classes em Python

- Todos os atributos e m√©todos s√£o p√∫blicos em Python üòµ‚Äçüí´
- Por conven√ß√£o, m√©todos iniciados com `_` s√£o tratados como se fossem privados.
- Os atributos geralmente s√£o tratados como p√∫blicos.
  - Assim, s√£o acessados diretamente `objeto.atributo`.
  - Mas podemos criar m√©todos com `@property` para ter a mesma prote√ß√£o de m√©todos 
    `get` e `set` sem quebrar a chamada acima.
- Por conven√ß√£o, podemos usar prefixo `_` para atributos que s√£o protegidos.
  - Ou ainda `__` que "dificulta" o acesso.

## Classes em Python

- Podemos ainda usar _type hints_  que ajudam muito a aumentar a produtividade
  e evitar erros de implementa√ß√£o.
- Como o foco aqui √© em desenvolvimento de jogos, vamos usar apenas o b√°sico de OO.
  - Mas voc√™ pode ver mais detalhes [nessa conversa com o ChatGPT](https://chatgpt.com/share/68e3b321-d30c-800e-a4dd-4fea8caf87f1).

## Controlando o _frame rate_

:::: {.columns}

::: {.column width="60%"}
```{.python filename="invasao_alien.py" code-line-numbers="4,12"}
    def __init__(self):
        """Inicializa o jogo e cria os recursos do jogo."""
        pygame.init()
        self.clock = pygame.time.Clock()
        # -- trecho de c√≥digo omitido -- 
        
    def executar_jogo(self):
        """Inicia o loop principal do jogo."""
        while True:
            # -- trecho de c√≥digo omitido -- 
            pygame.display.flip()
            self.clock.tick(60)  # Limita a 60 quadros por segundo                                 
```
:::

::: {.column width="40%"}
- `clock.tick(60)` evita que o loop rode mais de 60 vezes por segundo.
  - Evita sobrecarga da CPU.
  - Mant√©m consist√™ncia (FPS) do jogo.
- Obs.: pode ser necess√°rio ajustar o valor.
:::

::::


## Definindo a cor de fundo

```{.python filename="invasao_alien.py" code-line-numbers="5-6,16-17"}
    def __init__(self):
        # -- trecho de c√≥digo omitido -- 
        pygame.display.set_caption("Invas√£o Alien√≠gena")

        # Define a cor de fundo
        self.cor_fundo = (230, 230, 230)
        
    def executar_jogo(self):
        """Inicia o loop principal do jogo."""
        while True:
            # Observa eventos de teclado e mouse.
            for evento in pygame.event.get():
                if evento.type == pygame.QUIT:
                    sys.exit()
            
            # Redesenha a tela a cada passada do loop.
            self.tela.fill(self.cor_fundo)

            pygame.display.flip()
            self.clock.tick(60)  # Limita a 60 quadros por segundo
```

## Criando uma classe Settings

```{.python filename="config.py"}
class Settings:
    """ Classe para armazenar as configura√ß√µes do jogo Invas√£o Alien√≠gena. """

    def __init__(self):
        """ Inicializa as configura√ß√µes do jogo. """
        # Configura√ß√µes da tela
        self.largura_tela = 1200
        self.altura_tela = 800
        self.cor_fundo = (230, 230, 230)  # Cor de fundo cinza claro
```

- Boa pr√°tica para facilitar altera√ß√µes na apar√™ncia e comportamento do jogo.
- Concentra as configura√ß√µes em um √∫nico local, em vez de deixar espalhadas pelo c√≥digo.

##

```{.python filename="invasao_alien.py" code-line-numbers="3,12,14-15,22"}
import sys
import pygame
from config import Config

class InvasaoAlien:
    """Classe geral para gerenciar ativos e comportamento do jogo."""

    def __init__(self):
        """Inicializa o jogo e cria os recursos do jogo."""
        pygame.init()
        self.clock = pygame.time.Clock()
        self.config = Config()

        self.tela = pygame.display.set_mode(
            (self.config.largura_tela, self.config.altura_tela))
        pygame.display.set_caption("Invas√£o Alien√≠gena")
        
    def executar_jogo(self):
            # -- trecho de c√≥digo omitido -- 
            
            # Redesenha a tela a cada passada do loop.
            self.tela.fill(self.config.cor_fundo)

            pygame.display.flip()
            self.clock.tick(60)  # Limita a 60 quadros por segundo
```

# Criando uma nave {background-color="#40666e"}

##

Vamos agora criar a nave controlada pelo jogador.

- Aqui vamos usar uma imagem escolhida pelos autores do livro.
- Mas existem diversos sites com imagens gratuitas.
  - Al√©m dos Assistentes de IA que geram imagens.

##

::: {.callout-note title="ChatGPT üåê Sites de Sprites Gratuitos" icon="false" .nonincremental}

[Kenney.nl](https://kenney.nl/assets)

  - Sprites profissionais e organizados.
  - Tudo em CC0 (sem restri√ß√£o de uso).

[OpenGameArt.org](https://opengameart.org)

  - Gigante reposit√≥rio de sprites gratuitos.
  - Muitos j√° v√™m em pixel art ou estilo retr√¥ arcade.

[Itch.io ‚Äì Asset Packs gratuitos](https://itch.io/game-assets/free)

  - Packs de sprites feitos por artistas independentes.
  - Muitos permitem uso em jogos comerciais.
:::

##

::: {.callout-note title="ChatGPT üåê Sites de Sprites Gratuitos" icon="false" .nonincremental}

[CraftPix.net (Freebies)](https://craftpix.net/freebies/)

- Arte mais elaborada.
- Tem alguns pacotes gratuitos, mas muitos s√£o pagos.

**Google + Filtros de Licen√ßa** 

- V√° em Google Images > Ferramentas > Direitos de uso, filtre por _Creative Commons_.
- Assim evita problemas de copyright.
:::

## Criando a classe Nave


::: {.r-stretch}
```{.python filename="nave.py"}
import pygame

class Nave:
    """ Classe para cuidar da nave do jogador """

    def __init__(self, jogo):
        """ Inicializa a nave e define sua posi√ß√£o inicial. """
        self.tela = jogo.tela
        self.ret_tela = jogo.tela.get_rect()                          # 1

        # Carrega a imagem da nave e obt√©m seu ret√¢ngulo.
        # M√©todo convert √© importante para melhorar desempenho!       
        self.imagem = pygame.image.load('imagens/nave.png').convert() # 2
        self.ret = self.imagem.get_rect()

        # Come√ßa cada nave nova no centro inferior da tela.
        self.ret.midbottom = self.ret_tela.midbottom                  # 3

    def desenhar(self):
        """ Desenha a nave em sua posi√ß√£o atual. """
        self.tela.blit(self.imagem, self.ret)                         # 4
```
:::

## Criando a classe Nave {.smaller}

1. `pygame` trata todos os objetos como ret√¢ngulos (`Rect`).
  - Permitindo tratamento de colis√£o e posicionamento mais eficientes.
2. O m√©todo `convert()` melhora o desempenho do jogo.
  - Converte a imagem para um formato do pr√≥prio `pygame`.
3. Posiciona a nave no centro inferior da tela.
  - Veja que posicionamos o ret√¢ngulo da nave, n√£o a imagem.
  - Ret√¢ngulos t√™m propriedades como `top`, `bottom`, `left`, `right`, `center`, etc.
4. Desenha a imagem da nave na tela na posi√ß√£o definida pelo ret√¢ngulo.
  - Obs: `(0,0)` √© o canto superior esquerdo da tela.

## Desenhando a nave na tela

```{.python filename="invasao_alien.py" code-line-numbers="2,11,17"}
from config import Config
from nave import Nave

class InvasaoAlien:
    """Classe geral para gerenciar ativos e comportamento do jogo."""

    def __init__(self):
        # -- trecho de c√≥digo omitido -- 
        pygame.display.set_caption("Invas√£o Alien√≠gena")

        self.nave = Nave(self)
        
    def executar_jogo(self):
            # -- trecho de c√≥digo omitido -- 
            # Redesenha a tela a cada passada do loop.
            self.tela.fill(self.config.cor_fundo)
            self.nave.desenhar()
```

- Nave deve ser desenhada ap√≥s o preenchimento do fundo.

## Refatora√ß√£o

```{.python filename="invasao_alien.py" code-line-numbers="4-5,8-19"}
    def executar_jogo(self):
        """Inicia o loop principal do jogo."""
        while True:
            self._verificar_eventos()
            self._atualizar_tela()
            self.clock.tick(60)
    
    def _verificar_eventos(self):
        """Responde a eventos de teclado e mouse."""
        for evento in pygame.event.get():
            if evento.type == pygame.QUIT:
                sys.exit()
    
    def _atualizar_tela(self):
        """Desenha a nova imagem da tela do jogo e a utiliza na tela."""
        self.tela.fill(self.config.cor_fundo)
        self.nave.desenhar()
        
        pygame.display.flip()
``` 

## Pilotando a nave

```{.python filename="invasao_alien.py" code-line-numbers="6-8"}
    def _verificar_eventos(self):
        """Responde a eventos de teclado e mouse."""
        for evento in pygame.event.get():
            if evento.type == pygame.QUIT:
                sys.exit()
            elif evento.type == pygame.KEYDOWN:
                if evento.key == pygame.K_RIGHT:
                    self.nave.ret.x += 1
```

- Verificamos se um dos eventos √© uma tecla pressionada.
- Se a tecla pressionada for a seta para a direita, movemos a nave 1 pixel para a direita.
  - At√© aqui precisamos ficar pressionando a tecla para mover a nave.

## Movimento cont√≠nuo

```{.python filename="nave.py" code-line-numbers="7-13"}
    def __init__(self, jogo):
        # -- trecho de c√≥digo omitido --

        # Come√ßa cada nave nova no centro inferior da tela.
        self.ret.midbottom = self.ret_tela.midbottom

        # Flag de movimento; come√ßa com uma nave que n√£o est√° se movendo.
        self.movendo_direita = False
    
    def atualizar(self):
        """ Atualiza a posi√ß√£o da nave com base na flag de movimento. """
        if self.movendo_direita:
            self.ret.x += 1
```

- Definimos um atributo para indicar se a nave est√° se movendo para a direita.
- Criamos um m√©todo `atualizar` que vai ser chamado a cada passo do loop na classe `InvasaoAlien`.

## Movimento cont√≠nuo

```{.python filename="invasao_alien.py" code-line-numbers="5,14-19"}
    def executar_jogo(self):
        """Inicia o loop principal do jogo."""
        while True:
            self._verificar_eventos()
            self.nave.atualizar()
            self._atualizar_tela()
            self.clock.tick(60)
    
    def _verificar_eventos(self):
        """Responde a eventos de teclado e mouse."""
        for evento in pygame.event.get():
            if evento.type == pygame.QUIT:
                sys.exit()
            elif evento.type == pygame.KEYDOWN:
                if evento.key == pygame.K_RIGHT:
                    self.nave.movendo_direita = True
            elif evento.type == pygame.KEYUP: # se for evento de tecla liberada
                if evento.key == pygame.K_RIGHT:
                    self.nave.movendo_direita = False
```

## Movendo nas duas dire√ß√µes

```{.python filename="nave.py" code-line-numbers="6,12-13"}
    def __init__(self, jogo):
        # -- trecho de c√≥digo omitido --

        # Flags de movimento; come√ßa com uma nave que n√£o est√° se movendo.
        self.movendo_direita = False
        self.movendo_esquerda = False
    
    def atualizar(self):
        """ Atualiza a posi√ß√£o da nave com base nas flags de movimento. """
        if self.movendo_direita:
            self.ret.x += 1
        if self.movendo_esquerda:
            self.ret.x -= 1
```

- Movimento para a esquerda √© tratado de forma similar.

##

```{.python filename="invasao_alien.py" code-line-numbers="3-8"}
    def _verificar_eventos(self):
            # -- trecho de c√≥digo omitido --  
            if evento.type == pygame.KEYDOWN:
                if evento.key == pygame.K_LEFT:
                    self.nave.movendo_esquerda = True
            elif evento.type == pygame.KEYUP:
                if evento.key == pygame.K_LEFT:
                    self.nave.movendo_esquerda = False
```

## Ajustando a velocidade da nave

```{.python filename="config.py" code-line-numbers="4-5"}
    def __init__(self):
        # -- trecho de c√≥digo omitido --

        # Configura√ß√µes da nave
        self.velocidade_nave = 10.0
```

- Criamos uma configura√ß√£o para definir a velocidade da nave.
- Vamos incrementar por esse valor em vez de 1 a cada passo do loop do jogo.
- Vamos criar um atributo na nave para guardar a posi√ß√£o da nave com o tipo `float`
  para dar mais precis√£o ao movimento.
  - O atributo `x` guardar√° a posi√ß√£o mais precisa.
  - E o atributo `ret.x` continuar√° guardando a posi√ß√£o arredondada para desenhar a nave.

##

```{.python filename="nave.py" code-line-numbers="5,9-10,15,17,19"}
    def __init__(self, jogo):
        """ Inicializa a nave e define sua posi√ß√£o inicial. """
        self.tela = jogo.tela
        self.ret_tela = jogo.tela.get_rect()
        self.config = jogo.config
        
        # -- trecho de c√≥digo omitido --

        # Armazena um float para guardar a posi√ß√£o horizontal exata da nave
        self.x = float(self.ret.x)
    
    def atualizar(self):
        """ Atualiza a posi√ß√£o da nave com base nas flags de movimento. """
        if self.movendo_direita:
            self.x += self.config.velocidade_nave
        if self.movendo_esquerda:
            self.x -= self.config.velocidade_nave
        
        self.ret.x = int(self.x)
```

## Restringindo o alcance da Nave

```{.python filename="nave.py" code-line-numbers="3,5"}
    def atualizar(self):
        """ Atualiza a posi√ß√£o da nave com base nas flags de movimento. """
        if self.movendo_direita and self.ret.right < self.ret_tela.right:
            self.x += self.config.velocidade_nave
        if self.movendo_esquerda and self.ret.left > 0:
            self.x -= self.config.velocidade_nave
        
        self.ret.x = int(self.x)
```

- Vamos evitar que a nave saia da tela.
- Usamos as propriedades `right` e `left` do ret√¢ngulo da nave e da tela.

## Refatorando o m√©todo `_verificar_eventos()`

```{.python filename="invasao_alien.py" code-line-numbers="6-23"}
    def _verificar_eventos(self):
        """Responde a eventos de teclado e mouse."""
        for evento in pygame.event.get():
            if evento.type == pygame.QUIT:
                sys.exit()
            elif evento.type == pygame.KEYDOWN:
                self._verificar_eventos_tecla_pressionada(evento)
            elif evento.type == pygame.KEYUP:
                self._verificar_eventos_tecla_liberada(evento)
    
    def _verificar_eventos_tecla_pressionada(self, evento):
        """ Responde a teclas pressioandas"""
        if evento.key == pygame.K_RIGHT:
            self.nave.movendo_direita = True
        elif evento.key == pygame.K_LEFT:
            self.nave.movendo_esquerda = True
    
    def _verificar_eventos_tecla_liberada(self, evento):
        """ Responde a teclas liberadas"""
        if evento.key == pygame.K_LEFT:
            self.nave.movendo_esquerda = False
        elif evento.key == pygame.K_RIGHT:
            self.nave.movendo_direita = False
```

# Modo Tela Cheia {background-color="#40666e"}

## Fechar o jogo com a tecla `q`

```{.python filename="invasao_alien.py" code-line-numbers="7-8"}
    def _verificar_eventos_tecla_pressionada(self, evento):
        """ Responde a teclas pressioandas"""
        if evento.key == pygame.K_RIGHT:
            self.nave.movendo_direita = True
        elif evento.key == pygame.K_LEFT:
            self.nave.movendo_esquerda = True
        elif evento.key == pygame.K_q:
            sys.exit()
```

- `sys.exit()` n√£o √© a forma mais elegante de encerrar o jogo.
- Mas estava assim no livro :)

## Executando o jogo em modo Tela Cheia

```{.python filename="invasao_alien.py" code-line-numbers="7-9"}
    def __init__(self):
        """Inicializa o jogo e cria os recursos do jogo."""
        pygame.init()
        self.clock = pygame.time.Clock()
        self.config = Config()

        self.tela = pygame.display.set_mode((0,0), pygame.FULLSCREEN)
        self.config.largura_tela = self.tela.get_rect().width
        self.config.altura_tela = self.tela.get_rect().height
        pygame.display.set_caption("Invas√£o Alien√≠gena")
```

- Agora a largura e altura do jogo n√£o √© pr√©-definida.
    - Provavelmente pode ser interessante mudar a velocidade da nave.

##

::: {.callout-warning} 
Se n√£o tiv√©ssemos tratado a tecla `q` para sair do jogo, n√£o ter√≠amos uma forma
de sair do jogo no modo tela cheia.
:::

. . .

Nessa demonstra√ß√£o vamos ficar no modo janela mesmo.

- Devido ao tamanho das imagens e como foi planejada a inclus√£o dos alien√≠genas.

# Atirando {background-color="#40666e"}

## Configura√ß√£o dos proj√©teis

```{.python filename="config.py" code-line-numbers="4-8"}
    def __init__(self):
        # -- trecho de c√≥digo omitido --

        # Configura√ß√µes dos proj√©teis
        self.velocidade_projetil = 15.0
        self.largura_projetil = 3
        self.altura_projetil = 15
        self.cor_projetil = (60, 60, 60)  # Cor cinza escuro
```

- Vamos definir as configura√ß√µes dos proj√©teis (balas).
- Vamos criar uma classe para os proj√©teis.
  - Nela vamos usar um ret√¢ngulo simples para representar o proj√©til,
    em vez de uma imagem.

## Classe Projetil

```{.python filename="projetil.py"}
import pygame
from pygame.sprite import Sprite

class Projetil(Sprite):
    """ Classe para gerenciar proj√©teis disparados pela nave. """

    def __init__(self, ai_game):
        """ Cria um objeto de proj√©til na posi√ß√£o atual da nave. """
        super().__init__()
        self.tela = ai_game.tela
        self.config = ai_game.config
        self.cor = self.config.cor_projetil

        # Cria um proj√©til na posi√ß√£o (0,0) e depois define a posi√ß√£o correta.
        self.ret = pygame.Rect(0, 0, self.config.largura_projetil,
            self.config.altura_projetil)
        self.ret.midtop = ai_game.nave.ret.midtop

        # Guarda a posi√ß√£o do proj√©til como um float.
        self.y = float(self.ret.y)

    def update(self):
        """ Move o proj√©til para cima na tela. """
        # Atualiza a posi√ß√£o exata do proj√©til.
        self.y -= self.config.velocidade_projetil
        # Atualiza a posi√ß√£o do ret√¢ngulo.
        self.ret.y = self.y

    def desenhar(self):
        """ Desenha o proj√©til na tela. """
        pygame.draw.rect(self.tela, self.cor, self.ret)
```

## Heran√ßa em Python

Antes de criarmos os objetos proj√©teis no jogo, veja que estamos usando heran√ßa em Python.

- A classe `Projetil` herda de `Sprite`, que √© uma classe do `pygame`.
  - Estamos fazendo isso para conseguirmos usar grupos de sprites do `pygame`.
- A heran√ßa √© declarada com a sintaxe `class ClasseFilha(ClassePai):`.
- O construtor da classe pai √© chamado com `super().__init__()`.

## Heran√ßa em Python

- M√©todos da classe pai podem ser sobrescritos na classe filha.
  - Como fizemos com o m√©todo `update()`.
  - Podemos chamar m√©todos da classe pai com `super().metodo()`.

## Grupos de proj√©teis

```{.python filename="invasao_alien.py" code-line-numbers="2,10,17"}
from nave import Nave
from projetil import Projetil

class InvasaoAlien:

    def __init__(self):
        # -- trecho de c√≥digo omitido --

        self.nave = Nave(self)
        self.projeteis = pygame.sprite.Group()
        
    def executar_jogo(self):
        """Inicia o loop principal do jogo."""
        while True:
            self._verificar_eventos()
            self.nave.atualizar()
            self.projeteis.update() # Chama update() de cada proj√©til no grupo
            self._atualizar_tela()
            self.clock.tick(60)
```

## Disparando proj√©teis

```{.python filename="invasao_alien.py" code-line-numbers="5-6,11-14,19-20"}
    def _verificar_eventos_tecla_pressionada(self, evento):
        # -- trecho de c√≥digo omitido --
        elif evento.key == pygame.K_q:
            sys.exit()
        elif evento.key == pygame.K_SPACE: # tiros ser√£o disparados com espa√ßo
            self._disparar_projetil()
    
    def _verificar_eventos_tecla_liberada(self, evento):
        # -- trecho de c√≥digo omitido --

    def _disparar_projetil(self):
        """ Cria um novo proj√©til e o adiciona ao grupo de proj√©teis. """
        novo_projetil = Projetil(self)
        self.projeteis.add(novo_projetil)
    
    def _atualizar_tela(self):
        """Desenha a nova imagem da tela do jogo e a utiliza na tela."""
        self.tela.fill(self.config.cor_fundo)
        for projetil in self.projeteis.sprites(): # sprites() retorna uma lista
            projetil.desenhar()
        self.nave.desenhar()
        
        pygame.display.flip()
```

## Apagando proj√©teis fora da tela

```{.python filename="invasao_alien.py" code-line-numbers="8-12"}
    def executar_jogo(self):
        """Inicia o loop principal do jogo."""
        while True:
            self._verificar_eventos()
            self.nave.atualizar()
            self.projeteis.update()

            # Descarta os proj√©teis que desapareceram
            for projetil in self.projeteis.copy():   # 1
                if projetil.ret.bottom <= 0:
                    self.projeteis.remove(projetil)
            print(len(self.projeteis))               # 2

            self._atualizar_tela()
            self.clock.tick(60)
```

1. Fazemos c√≥pia para conserguirmos remover dentro do loop.
2. **Aten√ß√£o**: `print` deve ser removido depois de testar! Pois afeta o desempenho.

## Limitando o n√∫mero de proj√©teis

```{.python filename="config.py" code-line-numbers="4"}
    def __init__(self):
        # -- trecho de c√≥digo omitido --
        self.cor_projetil = (60, 60, 60)  # Cor cinza escuro
        self.max_projeteis = 5
```

```{.python filename="invasao_alien.py" code-line-numbers="3"}
    def _disparar_projetil(self):
        """ Cria um novo proj√©til e o adiciona ao grupo de proj√©teis. """
        if len(self.projeteis) < self.config.max_projeteis:
            novo_projetil = Projetil(self)
            self.projeteis.add(novo_projetil)
```

- Limitar o n√∫mero de proj√©teis incentiva o jogador a atirar com mais precis√£o.

## Refatora√ß√£o

```{.python filename="invasao_alien.py" code-line-numbers="6,12-19"}
    def executar_jogo(self):
        """Inicia o loop principal do jogo."""
        while True:
            self._verificar_eventos()
            self.nave.atualizar()
            self._atualizar_projeteis()
            self._atualizar_tela()
            self.clock.tick(60)
    
    # -- trecho de c√≥digo omitido --

    def _atualizar_projeteis(self):
        """ Atualiza a posi√ß√£o dos proj√©teis e descarta os proj√©teis antigos. """
        self.projeteis.update()

        # Livra-se dos proj√©teis que desapareceram.
        for projetil in self.projeteis.copy():
            if projetil.ret.bottom <= 0:
                self.projeteis.remove(projetil)
```

# Alien√≠genas {background-color="#40666e"}

##

Vamos agora adicionar os inimigos do jogo: os alien√≠genas.

- Vamos definir uma classe para representar um alien√≠gena.
- Depois vamos criar um esquadr√£o de alien√≠genas.
  - Faremos isso passo a passo.
  - Primeiro definindo uma linha de alien√≠genas.
  - E depois adicionamos mais linhas.

## Criando a classe Alien

```{.python filename="alien.py"}
import pygame
from pygame.sprite import Sprite

class Alien(Sprite):
    """ Classe para representar um √∫nico alien de um esquadr√£o. """

    def __init__(self, ai_game):
        """ Inicializa o alien e define sua posi√ß√£o inicial. """
        super().__init__()
        self.tela = ai_game.tela

        # Carrega a imagem do alien e define seu atributo retangulo.
        self.image = pygame.image.load('imagens/alien.png').convert()   # 1
        self.rect = self.image.get_rect()                               # 2

        # Come√ßa cada novo alien pr√≥ximo ao canto superior esquerdo da tela.
        # Considera um espa√ßo a partir da borda, do tamanho do ret√¢ngulo.
        self.rect.x = self.rect.width
        self.rect.y = self.rect.height

        # Armazena a posi√ß√£o horizontal exata do alien.
        self.x = float(self.rect.x)
```

## Criando a classe Alien

Aqui temos uma observa√ß√£o muito importante:

1. O atributo da imagem do alien deve ser chamado `image`.
2. E o do ret√¢ngulo do alien `rect`.
- Necess√°rios para que possamos usar grupos de sprites do `pygame`.

. . .

Isso tem rela√ß√£o com o conceito de [_duck typing_]{.alert} do Python.

## _Duck Typing_ em Python

Se um objeto tem os atributos e m√©todos esperados, ele pode ser usado.

- N√£o importa a classe do objeto.

. . .

Portanto, n√£o precisamos definir uma interface, 

- pois o Python se baseia no comportamento do objeto e n√£o em tipos expl√≠citos. 

. . .

Veja mais detalhes na [conversa com o ChatGPT](https://chatgpt.com/share/68e3b321-d30c-800e-a4dd-4fea8caf87f1)
mencionada antes.

## Criando uma inst√¢ncia do alien√≠gena

```{.python filename="invasao_alien.py" code-line-numbers="2,12-20,25-27"}
from projetil import Projetil
from alien import Alien

class InvasaoAlien:
    """Classe geral para gerenciar ativos e comportamento do jogo."""

    def __init__(self):
        # -- trecho de c√≥digo omitido --

        self.nave = Nave(self)
        self.projeteis = pygame.sprite.Group()
        self.aliens = pygame.sprite.Group()

        self._criar_esquadr√£o()

    def _criar_esquadr√£o(self):
        """Cria um esquadr√£o completo de aliens."""
        # por enquanto vamos criar apenas um alien
        alien = Alien(self)
        self.aliens.add(alien)
    
    def _atualizar_tela(self):
        # -- trecho de c√≥digo omitido --
        self.nave.desenhar()
        # ATEN√á√ÉO: para que todos os aliens sejam desenhados automaticamente
        # eles devem ter atributos chamados image e rect
        self.aliens.draw(self.tela)
        
        pygame.display.flip()
```

## Criando uma fileira de alien√≠genas

```{.python filename="invasao_alien.py"}
    def _criar_esquadr√£o(self):
        """Cria um esquadr√£o completo de aliens."""
        # Cria um alien√≠gena e continua criando aliens at√© que n√£o haja mais espa√ßo.
        # O distanciamento entre os aliens √© a largura de um alien.
        alien = Alien(self)
        largura_alien = alien.rect.width

        x_atual = largura_alien
        while x_atual < (self.config.largura_tela - 2 * largura_alien):
            self._criar_alien(x_atual)
            x_atual += 2 * largura_alien

    def _criar_alien(self, posicao_x):
        """ Cria um alien e coloca-o no esquadr√£o. """
        novo_alien = Alien(self)
        novo_alien.x = posicao_x
        novo_alien.rect.x = posicao_x
        self.aliens.add(novo_alien)
```

## Adicionando fileiras

```{.python filename="invasao_alien.py"}
    def _criar_esquadr√£o(self):
        """Cria um esquadr√£o completo de aliens."""
        # Cria um alien√≠gena e continua criando aliens at√© que n√£o haja mais espa√ßo.
        # O distanciamento entre os aliens √© a largura de um alien.
        alien = Alien(self)
        largura_alien, altura_alien = alien.rect.size

        x_atual, y_atual = largura_alien, altura_alien
        while y_atual < (self.config.altura_tela - 5 * altura_alien):            
            while x_atual < (self.config.largura_tela - 2 * largura_alien):
                self._criar_alien(x_atual, y_atual)
                x_atual += 2 * largura_alien

            x_atual = largura_alien
            y_atual += 2 * altura_alien
```

- `5 * altura_alien` indica a dist√¢ncia para a nave do jogador.

# Movendo o esquadr√£o {background-color="#40666e"}

## Movendo os alien√≠genas para a direita

```{.python filename="config.py"}
    def __init__(self):
        # -- trecho de c√≥digo omitido --

        # Configura√ß√µes dos aliens
        self.velocidade_alien = 1.0
```

. . .

```{.python filename="alien.py"}
    def __init__(self, ai_game):
        """ Inicializa o alien e define sua posi√ß√£o inicial. """
        super().__init__()
        self.tela = ai_game.tela
        self.config = ai_game.config

        # -- trecho de c√≥digo omitido --

    def update(self):
        """ Move o alien para a direita. """
        self.x += self.config.velocidade_alien
        self.rect.x = self.x
```

##

```{.python filename="invasao_alien.py" code-line-numbers="7,11-13"}
    def executar_jogo(self):
        """Inicia o loop principal do jogo."""
        while True:
            self._verificar_eventos()
            self.nave.atualizar()
            self._atualizar_projeteis()
            self._atualizar_aliens()
            self._atualizar_tela()
            self.clock.tick(60)

    def _atualizar_aliens(self):
        """Atualiza as posi√ß√µes de todos os aliens do esquadr√£o."""
        self.aliens.update()
```

- At√© aqui os aliens se movem para a direita e continuam se 
  movendo mesmo depois de sa√≠rem da tela.
- No pr√≥ximo passo vamos fazer o esquadr√£o descer e mudar de dire√ß√£o.

## Configurando descida e mudan√ßa de dire√ß√£o

```{.python filename="config.py"}
    def __init__(self):
        # -- trecho de c√≥digo omitido --

        # Configura√ß√µes dos aliens
        self.velocidade_alien = 1.0
        self.velocidade_descida_esquadrao = 10.0
        self.direcao_esquadrao = 1  # 1 representa a direita; -1 representa a esquerda
```

- Configuramos o quanto os aliens descem quando atingem uma borda.
- E usamos um valor inteiro para a dire√ß√£o.
  - Pois a√≠ podemos simplesmente multiplicar a velocidade pela dire√ß√£o,
    em vez de fazer uma verifica√ß√£o condicional.

## Tratando dire√ß√£o e criando m√©todo para verificar borda

```{.python filename="alien.py"}
    def update(self):
        """ Move o alien para a direita ou para a esquerda. """
        self.x += self.config.velocidade_alien * self.config.direcao_esquadrao
        self.rect.x = self.x
    
    def verificar_borda(self):
        """ Retorna True se o alien estiver na borda da tela. """
        ret_tela = self.tela.get_rect()
        return self.rect.right >= ret_tela.right or self.rect.left <= 0
```

- O m√©todo `verificar_borda()` ser√° usado na classe `InvasaoAlien`.
  - Se um dos aliens atingir uma borda, todo o esquadr√£o deve descer e mudar de dire√ß√£o.

## Fazendo a frota descer e mudar de dire√ß√£o

```{.python filename="invasao_alien.py"}
    def _atualizar_aliens(self):
        """ Verifica se o esquadr√£o est√° na borda e atualiza as posi√ß√µes dos aliens. """
        self._verificar_bordas_esquadrao()
        self.aliens.update()

    def _verificar_bordas_esquadrao(self):
        """ Faz o esquadr√£o descer se um dos aliens atingiu uma borda. """
        for alien in self.aliens.sprites():
            if alien.verificar_borda():
                self._descer_esquadrao()
                break
    
    def _descer_esquadrao(self):
        """ Desce o esquadr√£o e muda sua dire√ß√£o. """
        for alien in self.aliens.sprites():
            alien.rect.y += self.config.velocidade_descida_esquadrao
        self.config.direcao_esquadrao *= -1
```

# Eliminando aliens {background-color="#40666e"}

## Detectando colis√µes de proj√©teis

```{.python filename="invasao_alien.py"}
    def _atualizar_projeteis(self):
        # -- trecho de c√≥digo omitido --

        # Verifica se algum proj√©til atingiu um alien.
        # Se sim, descarta tanto o proj√©til quanto o alien.
        colisoes = pygame.sprite.groupcollide(
            self.projeteis, self.aliens, True, True)
```

- `groupcollide()` detecta colis√µes entre dois grupos de sprites.
- Os dois √∫ltimos argumentos indicam se os objetos envolvidos na colis√£o devem ser removidos.
  - No nosso caso, tanto o proj√©til quanto o alien s√£o removidos.

##

```output
Traceback (most recent call last):
  File "/home/julio/Downloads/invasao-alienigena/invasao_alien.py", line 141, in <module>
    ai.executar_jogo()
  File "/home/julio/Downloads/invasao-alienigena/invasao_alien.py", line 33, in executar_jogo
    self._atualizar_projeteis()
  File "/home/julio/Downloads/invasao-alienigena/invasao_alien.py", line 72, in _atualizar_projeteis
    if projetil.ret.bottom <= 0:
       ^^^^^^^^^^^^
AttributeError: 'Projetil' object has no attribute 'ret'. Did you mean: 'rect'?
```

- Precisamos mudar o nome do atributo `ret` da classe `Projetil` para `rect`.
- Isso porque o m√©todo `groupcollide()` espera que os objetos tenham um atributo chamado `rect`.
  - Veja que n√£o precisamos, necessariamente, fazer `Projetil` herdar de `Sprite`.
  - √â um exemplo do _duck typing_ do Python.

## Criando proj√©teis maiores para testes

. . .

Em um jogo √© muito comum precisarmos avan√ßar a um certo ponto para conseguir fazer testes.

- E √© muito mais produtivo alterarmos, temporariamente, alguma configura√ß√£o do jogo.
- Do que ter que jogar "normalmente" at√© chegar ao ponto desejado.

. . .

Para facilitar os testes de colis√£o, por exemplo, podemos aumentar a largura dos proj√©teis.

- Vamos experimentar 400.

## Recriando o esquadr√£o

A principal funcionalidade do jogo √© que os alien√≠genas s√£o implac√°veis.

- Sempre que o esquadr√£o for destru√≠do, um novo aparece.
- Vamos implementar isso agora.

. . .

```{.python filename="invasao_alien.py"}
    def _atualizar_projeteis(self):
        # -- trecho de c√≥digo omitido --
        
        if not self.aliens:
            # Destr√≥i os proj√©teis existentes e cria um novo esquadr√£o.
            self.projeteis.empty()
            self._criar_esquadr√£o()
```

## Refatorando `_atualizar_projeteis()`

```{.python filename="invasao_alien.py"}
    def _atualizar_projeteis(self):
        """ Atualiza a posi√ß√£o dos proj√©teis e descarta os proj√©teis antigos. """
        self.projeteis.update()

        # Livra-se dos proj√©teis que desapareceram.
        for projetil in self.projeteis.copy():
            if projetil.rect.bottom <= 0:
                self.projeteis.remove(projetil)

        self._verificar_colisoes_projeteis_aliens()
    
    def _verificar_colisoes_projeteis_aliens(self):
        """ Responde a colis√µes entre proj√©teis e aliens. """
        # Verifica se algum proj√©til atingiu um alien.
        # Se sim, descarta tanto o proj√©til quanto o alien.
        colisoes = pygame.sprite.groupcollide(
            self.projeteis, self.aliens, True, True)
        
        if not self.aliens:
            # Destr√≥i os proj√©teis existentes e cria um novo esquadr√£o.
            self.projeteis.empty()
            self._criar_esquadr√£o()
```

# Dando um fim ao jogo {background-color="#40666e"}


## Detectando colis√µes entre naves e aliens

```{.python filename="invasao_alien.py" code-line-numbers="8-10"}

# -- trecho de c√≥digo omitido --
    def _atualizar_aliens(self):
        """ Verifica se o esquadr√£o est√° na borda e atualiza as posi√ß√µes dos aliens. """
        self._verificar_bordas_esquadrao()
        self.aliens.update()

        # Detecta colis√µes entre a nave e os aliens.
        if pygame.sprite.spritecollideany(self.nave, self.aliens):
            print("A nave foi atingida!")
```


- `spritecollideany()` verifica se um `Sprite` colidiu com algum sprite de um grupo.
- Por enquanto estamos apenas testando a colis√£o.
- Obs.: pode ser interessante mudar a velocidade dos aliens para facilitar os testes. 

##

Aqui, novamente, precisaremos usar atributo com nome `rect` em vez de `ret`.

- Devido ao _duck typing_ do Python, lembra?

. . .

Dica: se estiver usando um _linter_ como o `pylance` voc√™ ver√° um warning em `self.nave`.


## Criando classe `Estatisticas` antes de tratar a colis√£o


```{.python filename="config.py"}
    def __init__(self):
        # -- trecho de c√≥digo omitido --

        # Configura√ß√µes da nave
        self.velocidade_nave = 10.0
        self.max_naves = 3
```

. . .

```{.python filename="estatisticas.py"}
class Estatisticas:
    """ Rastreia as estat√≠sticas do jogo. """

    def __init__(self, jogo):
        """ Inicializa as estatisticas """
        self.config = jogo.config
        self.reiniciar()

    def reiniciar(self):
        """ Inicializa as estat√≠sticas que podem mudar ao longo do jogo. """
        self.naves_restantes = self.config.max_naves
```


##

```{.python filename="invasao_alien.py" code-line-numbers="2,5,13-14,23-39"}
import sys
from time import sleep
import pygame
from config import Config
from estatisticas import Estatisticas

# -- trecho de c√≥digo omitido --

    def __init__(self):
        # -- trecho de c√≥digo omitido --
        pygame.display.set_caption("Invas√£o Alien√≠gena")

        # Cria uma inst√¢ncia para armazenar estat√≠sticas do jogo.
        self.estatisticas = Estatisticas(self)

    # -- trecho de c√≥digo omitido --

    def _atualizar_aliens(self):
        # -- trecho de c√≥digo omitido --

        # Detecta colis√µes entre a nave e os aliens.
        if pygame.sprite.spritecollideany(self.nave, self.aliens):
            self._acertar_nave()
    
    def _acertar_nave(self):
        """ Responde a uma colis√£o entre a nave e um alien. """
        # Decrementa naves_restantes.
        self.estatisticas.naves_restantes -= 1

        # Esvazia a lista de aliens e proj√©teis.
        self.aliens.empty()
        self.projeteis.empty()

        # Cria um novo esquadr√£o e centraliza a nave.
        self._criar_esquadr√£o()
        self.nave.centralizar()

        # Faz uma pausa de meio segundo.
        sleep(0.5)
```

##

```{.python filename="nave.py"}
    def centralizar(self):
        """ Centraliza a nave na tela. """
        self.rect.midbottom = self.ret_tela.midbottom
        self.x = float(self.rect.x)
```

Repare que sempre usamos a mesma inst√¢ncia da nave.

- N√≥s n√£o criamos outro objeto quando a nave √© atingida.
- N√≥s apenas a centralizamos.
- A classe de estat√≠sticas cuida de lidar com quantas vidas existem.

## Tratando alien√≠genas na borda inferior

```{.python filename="invasao_alien.py" code-line-numbers="8-17"}
    def _atualizar_aliens(self):
        # -- trecho de c√≥digo omitido --

        # Detecta colis√µes entre a nave e os aliens.
        if pygame.sprite.spritecollideany(self.nave, self.aliens):
            self._acertar_nave()

        # Verifica se algum alien atingiu a parte inferior da tela.
        self._verificar_aliens_borda_inferior()

    def _verificar_aliens_borda_inferior(self):
        """ Verifica se algum alien atingiu a parte inferior da tela. """
        for alien in self.aliens.sprites():
            if alien.rect.bottom >= self.config.altura_tela:
                # Trata esse caso do mesmo modo que se a nave tivesse sido atingida.
                self._acertar_nave()
                break
```

## Game Over!

```{.python filename="invasao_alien.py" code-line-numbers="5-6,12-14"}

    def __init__(self):
        # -- trecho de c√≥digo omitido --

        # Inicializa o jogo em um estado ativo
        self.jogo_ativo = True
    
    # -- trecho de c√≥digo omitido --

    def _acertar_nave(self):
        """ Responde a uma colis√£o entre a nave e um alien. """
        if self.estatisticas.naves_restantes <= 0:
            self.jogo_ativo = False
            return
        
        # -- trecho de c√≥digo omitido --
```

- Criamos um atributo para indicar se o jogo est√° ativo ou se terminou.

## Parando execu√ß√£o de partes do jogo no Game Over

```{.python filename="invasao_alien.py" code-line-numbers="6-9"}
    def executar_jogo(self):
        """Inicia o loop principal do jogo."""
        while True:
            self._verificar_eventos()
            
            if self.jogo_ativo:
                self.nave.atualizar()
                self._atualizar_projeteis()
                self._atualizar_aliens()

            self._atualizar_tela()
            self.clock.tick(60)
```

- Usamos o atributo para que as atualiza√ß√µes do jogo parem.

##

Temos agora uma vers√£o jog√°vel do Invas√£o Alien√≠gena.

- Mas ainda temos muito o que melhorar.
- Precisamos fazer com que os aliens fiquem mais r√°pidos a cada esquadr√£o destru√≠do.
- Precisamos tamb√©m adicionar pontua√ß√£o, por exemplo.

. . .

Faremos essas e outras melhorias na pr√≥xima aula.





